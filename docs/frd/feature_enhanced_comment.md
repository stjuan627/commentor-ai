# 功能需求：增强评论生成功能

## 1. 功能描述

为 Commentor.ai 扩展增强评论生成功能，主要包括关键词管理、自动提取内容、多语言支持以及增强的评论复制选项。

## 2. 详细需求

### 2.1 关键词管理

- 在侧边栏中添加关键词管理功能，允许用户添加、编辑和删除关键词记录
- 每条记录包含关键词（keyword）和对应的网址（url）
- 数据结构：`{ keyword: string, url: string }[]`
- 使用浏览器存储 API 持久化保存关键词数据
- 用户界面应包括添加新记录的表单和已有记录的列表视图

### 2.2 自动提取页面内容

- 移除现有的"提取当前页面内容"按钮
- 在用户点击"生成评论"按钮时自动提取当前页面内容
- 保留提取内容的逻辑，但改为在评论生成流程中自动调用

### 2.3 关键词参数传递

- 在调用 LLM 服务生成评论时，将用户定义的关键词列表作为参数传递
- 修改 `generateComment` 方法，接收关键词参数并传递给 LLM 服务
- 更新 LLM 服务接口和实现，支持处理关键词参数

### 2.4 多语言评论支持

- 获取当前页面的语言代码（langcode）
- 将语言代码作为参数传递给评论生成模块
- 当语言代码非空且不是英文（非 "en"）时：
  - 生成双语评论
  - 首先生成英文版本评论
  - 然后生成当前页面语言版本的评论
  - 将两个版本合并展示

### 2.5 增强评论复制功能

- 提供两种复制评论的选项：
  1. **复制为普通链接**：
     - 识别评论文本中出现的关键词
     - 为匹配的关键词添加 HTML 超链接 `<a href="url">keyword</a>`
     - 复制带有 HTML 链接的评论文本到剪贴板
  
  2. **复制为 Markdown 格式**：
     - 识别评论文本中出现的关键词
     - 为匹配的关键词添加 Markdown 格式的链接 `[keyword](url)`
     - 复制带有 Markdown 链接的评论文本到剪贴板

## 3. 技术实现要点

- 使用 `browser.storage.local` API 持久化存储关键词数据
- 扩展现有的 `LLMService` 接口，支持处理关键词和语言代码参数
- 修改 `generatePrompt` 函数，将关键词和语言代码整合到提示模板中
- 实现关键词匹配算法，用于在评论文本中识别关键词并添加超链接
- 使用 `document.documentElement.lang` 或类似方法获取页面语言代码

## 4. 用户界面变更

- 添加关键词管理区域，包括：
  - 添加新关键词的表单（关键词输入框和URL输入框）
  - 已添加关键词的列表，每项包含编辑和删除选项
- 移除"提取当前页面内容"按钮
- 更新"生成评论"按钮的行为
- 添加两个新的复制按钮："复制为普通链接"和"复制为Markdown格式"

## 5. TODO 列表

- [x] 实现关键词管理功能
  - [x] 创建关键词管理 UI 组件
  - [x] 实现关键词的添加、编辑和删除功能
  - [x] 实现关键词数据的持久化存储
- [x] 修改页面内容提取逻辑
  - [x] 移除独立的提取按钮
  - [x] 在生成评论流程中集成自动提取功能
- [x] 更新 LLM 服务接口
  - [x] 修改接口定义，支持关键词和语言代码参数
  - [x] 更新 OpenAI 和 Gemini 服务实现
- [x] 实现多语言评论生成
  - [x] 添加获取页面语言代码的功能
  - [x] 实现双语评论生成逻辑
- [x] 增强评论复制功能
  - [x] 实现关键词匹配和链接添加算法
  - [x] 添加"复制为普通链接"和"复制为Markdown格式"按钮
  - [x] 实现相应的复制功能

## 6. 实现总结

本次增强评论生成功能的开发已全部完成，主要实现了以下功能：

### 1. 关键词管理

- 添加了关键词管理区域，允许用户添加、编辑和删除关键词及其对应的 URL
- 实现了关键词的持久化存储，使用 `browser.storage.local` API
- 定义了 `KeywordItem` 数据结构，包含 `keyword` 和 `url` 属性

### 2. 多语言评论生成

- 在内容脚本中实现了获取页面语言的功能，可以从 HTML 标签、meta 标签等处获取语言代码
- 在后台脚本中添加了获取页面语言的消息处理功能
- 更新了生成评论的逻辑，支持根据页面语言生成双语评论

### 3. LLM 服务接口更新

- 更新了 LLM 服务接口，增加了关键词和语言代码参数
- 更新了 OpenAI 和 Gemini 服务实现，支持新的参数

### 4. 评论复制功能增强

- 实现了关键词匹配和链接添加算法，可以在评论中自动添加关键词的超链接
- 添加了两个新的复制按钮，分别用于复制普通链接和 Markdown 格式的链接

### 5. UI 优化

- 修复了 CSS 样式冲突，删除了重复的 `p-0` 和 `p-4` 样式
- 优化了用户界面，增强了用户体验

所有功能已经实现并测试完成，可以满足用户的需求。
